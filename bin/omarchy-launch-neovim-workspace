#!/bin/bash
set -euo pipefail

# Launch Neovim in a chosen workspace directory.
# Usage:
#   omarchy-launch-neovim-workspace                   # prompt with Walker (favorites + browse)
#   omarchy-launch-neovim-workspace --direct <path>   # open path directly without prompt
#   omarchy-launch-neovim-workspace --favorite-add <path>    # add directory to favorites list
#   omarchy-launch-neovim-workspace --favorite-remove <path> # remove directory from favorites
#   omarchy-launch-neovim-workspace --favorite-list          # print favorite directories

OMARCHY_BIN_DIR="$HOME/.local/share/omarchy/bin"
LAUNCH_EDITOR_BIN="$OMARCHY_BIN_DIR/omarchy-launch-editor"
DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
FAVORITES_FILE="$DATA_HOME/omarchy/neovim-workspace-favorites"

# Resolve a user-provided path (expand ~ and env vars)
resolve_path() {
  local input_path="$1"
  # shellcheck disable=SC2086
  local expanded
  expanded=$(eval echo "$input_path")
  printf '%s' "$expanded"
}

ensure_favorites_file() {
  mkdir -p "$(dirname "$FAVORITES_FILE")"
  [[ -f "$FAVORITES_FILE" ]] || : >"$FAVORITES_FILE"
}

load_favorites() {
  local array_name="$1"
  local -n favorites_ref="$array_name"
  favorites_ref=()

  ensure_favorites_file

  local -A seen=()
  local line
  while IFS= read -r line || [[ -n "$line" ]]; do
    [[ -z "$line" || "$line" == \#* ]] && continue
    local resolved
    resolved=$(resolve_path "$line")
    [[ -d "$resolved" ]] || continue
    if [[ -n "${seen[$resolved]:-}" ]]; then
      continue
    fi
    seen["$resolved"]=1
    favorites_ref+=("$resolved")
  done < "$FAVORITES_FILE"
}

save_favorites() {
  local -n favorites_ref="$1"
  ensure_favorites_file
  printf '%s\n' "${favorites_ref[@]}" > "$FAVORITES_FILE"
}

favorite_label() {
  local path="$1"
  local name
  name=$(basename "$path")
  if [[ -z "$name" || "$name" == "." || "$name" == "/" ]]; then
    name="$path"
  fi
  printf '%s' "$name"
}

add_favorite_directory() {
  local raw_path="$1"
  local resolved
  resolved=$(resolve_path "$raw_path")

  if [[ ! -d "$resolved" ]]; then
    echo "Not a directory: $raw_path" >&2
    exit 1
  fi

  ensure_favorites_file

  if grep -Fxq "$resolved" "$FAVORITES_FILE"; then
    echo "Already in favorites: $resolved"
    return
  fi

  printf '%s\n' "$resolved" >> "$FAVORITES_FILE"
  echo "Added to favorites: $resolved"
}

remove_favorite_directory() {
  local raw_path="$1"
  local resolved
  resolved=$(resolve_path "$raw_path")

  ensure_favorites_file

  if ! grep -Fxq "$resolved" "$FAVORITES_FILE"; then
    echo "Not in favorites: $resolved"
    return
  fi

  local -a favorites=()
  while IFS= read -r line || [[ -n "$line" ]]; do
    [[ -z "$line" || "$line" == \#* ]] && continue
    if [[ "$line" != "$resolved" ]]; then
      favorites+=("$line")
    fi
  done < "$FAVORITES_FILE"

  save_favorites favorites
  echo "Removed from favorites: $resolved"
}

list_favorite_directories() {
  local -a favorites=()
  load_favorites favorites
  if ((${#favorites[@]} == 0)); then
    echo "No favorites set"
    return
  fi
  printf '%s\n' "${favorites[@]}"
}

open_in_editor() {
  local target_dir="$1"
  # Always launch editor with selected directory as CWD
  exec setsid "$LAUNCH_EDITOR_BIN" --cwd "$target_dir"
}

# Try to interpret raw input as a path and open it
open_if_path_like() {
  local input_text="$1"
  [[ -z "$input_text" ]] && return 1

  # Accept absolute paths, ~ expansion, env vars, or relative paths
  local resolved
  resolved=$(resolve_path "$input_text")
  if [[ -d "$resolved" ]]; then
    open_in_editor "$resolved"
    return 0
  fi
  return 1
}

# Directory-only navigator using Walker, starting at $HOME
navigate_directories() {
  local current_dir="$HOME"
  while true; do
    local -a entries=("Open here => $current_dir")
    if [[ "$current_dir" != "/" ]]; then
      entries+=(".. => $(dirname "$current_dir")")
    fi
    while IFS= read -r -d '' dir; do
      entries+=("$(basename "$dir") => $dir")
    done < <(find "$current_dir" -mindepth 1 -maxdepth 1 -type d ! -name '.*' -print0 2>/dev/null | sort -z)

    local selection
    selection=$(printf '%s\n' "${entries[@]}" | walker --dmenu --theme dmenu_250 -p "Browse: $current_dir…" -w 1100)
    [[ -z "$selection" || "$selection" == CNCLD ]] && exit 0

    local chosen_path
    chosen_path="${selection##* => }"

    # If the user chose the same directory as 'Open here'
    if [[ "$chosen_path" == "$current_dir" ]]; then
      open_in_editor "$current_dir"
    else
      current_dir="$chosen_path"
    fi
  done
}

choose_workspace() {
  # Present favorite directories first; fall back to manual browsing
  local IFS=$'\n'
  local -a entries=("Browse…")
  local -a favorites=()
  load_favorites favorites

  if ((${#favorites[@]} == 0)); then
    navigate_directories
    return
  fi

  local path
  for path in "${favorites[@]}"; do
    local label
    label=$(favorite_label "$path")
    entries+=("$label => $path")
  done

  local prompt="Neovim: Path"
  local selection
  selection=$(printf '%s\n' "${entries[@]}" | walker --dmenu --theme dmenu_250 -p "$prompt…" -w 900)

  case "${selection:-}" in
    ''|CNCLD)
      exit 0 ;;
    'Browse…')
      navigate_directories ;;
    *)
      # Treat selection as a labelled entry (`label => path`) or raw input
      local chosen="$selection"
      if [[ "$selection" == *" => "* ]]; then
        chosen="${selection##* => }"
      fi
      open_if_path_like "$chosen" || { notify-send "Neovim" "Not a directory: $chosen"; exit 1; } ;;
  esac
}

main() {
  case ${1:-} in
    --direct|-d)
      if [[ -z ${2:-} ]]; then
        echo "Error: --direct requires a path" >&2
        exit 2
      fi
      local path
      path=$(resolve_path "$2")
      open_in_editor "$path" ;;
    --favorite-add)
      if [[ -z ${2:-} ]]; then
        echo "Error: --favorite-add requires a path" >&2
        exit 2
      fi
      add_favorite_directory "$2" ;;
    --favorite-remove)
      if [[ -z ${2:-} ]]; then
        echo "Error: --favorite-remove requires a path" >&2
        exit 2
      fi
      remove_favorite_directory "$2" ;;
    --favorite-list)
      list_favorite_directories ;;
    *)
      choose_workspace ;;
  esac
}

main "$@"
